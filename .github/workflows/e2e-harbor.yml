# E2E test: start Harbor, docker login to verify, then Helm push our chart (OCI)
name: E2E Harbor Helm Push

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  harbor-e2e:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget curl jq

      - name: Add harbor.local DNS (runner host)
        run: |
          echo "127.0.0.1 harbor.local" | sudo tee -a /etc/hosts
          cat /etc/hosts

      # Allow Docker and Helm to use HTTP registry; 172.17.0.1 = host from action container (Linux has no host.docker.internal)
      - name: Configure Docker for insecure localhost registry
        run: |
          echo '{"insecure-registries": ["harbor.local"]}' | sudo tee /etc/docker/daemon.json
          sudo systemctl restart docker
          sleep 10
          docker info

      - name: Install Docker Compose (for Harbor install script)
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose --version

      - name: Download Harbor
        run: |
          wget -q https://github.com/goharbor/harbor/releases/download/v2.10.0/harbor-online-installer-v2.10.0.tgz
          tar xzf harbor-online-installer-v2.10.0.tgz

      - name: Configure Harbor (HTTP)
        run: |
          cd harbor
          cp harbor.yml.tmpl harbor.yml

          sed -i 's/hostname: reg.mydomain.com/hostname: harbor.local/' harbor.yml
          sed -i 's/^https:/#https:/g' harbor.yml
          sed -i 's/^  port: 443/#  port: 443/g' harbor.yml
          echo "external_url: http://harbor.local" >> harbor.yml
          cat harbor.yml

      - name: Start Harbor
        run: |
          cd harbor
          sudo ./install.sh --with-trivy

      - name: Wait for Harbor to be ready
        run: |
          for i in $(seq 1 30); do
            code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost/api/v2.0/health || true)
            if [ "$code" = "200" ]; then
              echo "Harbor is ready"
              exit 0
            fi
            echo "Waiting for Harbor... ($i/30) (http_code=$code)"
            sleep 10
          done
          echo "Harbor did not become ready"
          exit 1

      - name: Create Harbor project for Helm (OCI)
        run: |
          curl -s -X POST "http://localhost/api/v2.0/projects" \
            -u "admin:Harbor12345" \
            -H "Content-Type: application/json" \
            -d '{"project_name":"helm-e2e","public":false}' \
            -o /dev/null -w "%{http_code}" | grep -qE "201|409" || true
          # 409 = project already exists

      - name: Docker login to Harbor (verify registry)
        run: |
          echo "Harbor12345" | docker login harbor.local -u admin --password-stdin
          docker logout harbor.local

      - name: Install Helm (for verify step)
        run: |
          HELM_VERSION=3.16.3
          curl -sSL "https://get.helm.sh/helm-v${HELM_VERSION}-linux-amd64.tar.gz" | tar -C /tmp -xzf -
          sudo mv /tmp/linux-amd64/helm /usr/local/bin/helm
          helm version

      - name: Push chart using HelmPush action (E2E)
        uses: ./
        with:
          registry-url: oci://harbor.local/helm-e2e
          username: admin
          password: Harbor12345
          chart-folder: chart
          plain-http: true

      - name: Verify push (helm pull)
        run: |
          helm pull oci://harbor.local/helm-e2e/e2e-test-chart --version 0.1.0 --untar
          test -f e2e-test-chart/Chart.yaml
          grep -q "e2e-test-chart" e2e-test-chart/Chart.yaml
