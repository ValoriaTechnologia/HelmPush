name: E2E Harbor Helm Push HTTPS

on:
  push:
    branches: [main]

jobs:
  harbor-e2e:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget curl jq openssl

      - name: Configure Docker
        run: |
          echo '{"insecure-registries":["172.17.0.1"]}' | sudo tee /etc/docker/daemon.json
          sudo systemctl restart docker
          sleep 10

      - name: Install Docker Compose
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose --version

      - name: Download Harbor
        run: |
          wget -q https://github.com/goharbor/harbor/releases/download/v2.10.0/harbor-online-installer-v2.10.0.tgz
          tar xzf harbor-online-installer-v2.10.0.tgz

      - name: Generate self-signed certificate
        run: |
          mkdir -p harbor/certs
          openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
            -keyout harbor/certs/harbor.key \
            -out harbor/certs/harbor.crt \
            -subj "/CN=localhost"

      - name: Configure Harbor for HTTPS
        run: |
          cd harbor
          cp harbor.yml.tmpl harbor.yml
          sed -i "s/hostname: reg.mydomain.com/hostname: 172.17.0.1/" harbor.yml
          echo "protocol: https" >> harbor.yml
          echo "port: 443" >> harbor.yml
          echo "certificate: ./certs/harbor.crt" >> harbor.yml
          echo "private_key: ./certs/harbor.key" >> harbor.yml
          echo "external_url: https://172.17.0.1" >> harbor.yml
          cat harbor.yml

      - name: Start Harbor
        run: |
          export TERM=xterm
          cd harbor
          sudo ./install.sh --with-trivy

      - name: Wait for Harbor ready
        run: |
          for i in $(seq 1 30); do
            code=$(curl -k -s -o /dev/null -w "%{http_code}" https://172.17.0.1/api/v2.0/health || true)
            if [ "$code" = "200" ]; then
              echo "Harbor is ready"
              exit 0
            fi
            echo "Waiting for Harbor... ($i/30) http_code=$code"
            sleep 10
          done
          echo "Harbor did not become ready"
          exit 1

      - name: Create Harbor project for Helm (OCI)
        run: |
          curl -k -s -X POST "https://172.17.0.1/api/v2.0/projects" \
            -u "admin:Harbor12345" \
            -H "Content-Type: application/json" \
            -d '{"project_name":"helm-e2e","public":false}' \
            -o /dev/null -w "%{http_code}" | grep -qE "201|409" || true

      - name: Docker login to Harbor (verify registry)
        run: |
          echo "Harbor12345" | docker login 172.17.0.1 -u admin --password-stdin
          docker logout 172.17.0.1

      - name: Install Helm
        run: |
          HELM_VERSION=3.16.3
          curl -sSL "https://get.helm.sh/helm-v${HELM_VERSION}-linux-amd64.tar.gz" | tar -C /tmp -xzf -
          sudo mv /tmp/linux-amd64/helm /usr/local/bin/helm
          helm version

      - name: Push chart using HelmPush action (E2E)
        uses: ./
        with:
          registry-url: oci://172.17.0.1/helm-e2e
          username: admin
          password: Harbor12345
          chart-folder: chart

      - name: Helm pull chart
        run: |
          export HELM_EXPERIMENTAL_OCI=1
          helm registry login https://172.17.0.1 --username admin --password Harbor12345 --insecure-skip-tls-verify
          helm pull oci://172.17.0.1/helm-e2e/e2e-test-chart --version 0.1.0 --untar
          test -f e2e-test-chart/Chart.yaml
          grep -q "e2e-test-chart" e2e-test-chart/Chart.yaml